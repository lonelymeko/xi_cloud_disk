# 布隆过滤器配置说明

## 🎯 功能介绍

布隆过滤器用于快速判断文件hash是否存在，提高文件秒传效率。系统会在启动时自动加载或创建布隆过滤器，并定期将其持久化到文件。

## ⚙️ 配置参数

### 环境变量配置

在 `.env` 文件中可以配置以下参数：

```bash
# 布隆过滤器定期保存间隔（可选，默认30分钟）
# 支持格式：30m, 1h, 2h30m 等
BLOOM_FILTER_SAVE_INTERVAL=30m
```

### 配置说明

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `BLOOM_FILTER_SAVE_INTERVAL` | 定期间隔 | 30分钟 | `1h` (1小时), `15m` (15分钟) |

## 📁 文件说明

### 持久化文件
- **文件路径**：`./bloom_filter.data`
- **用途**：存储布隆过滤器的二进制数据
- **自动创建**：首次运行时自动创建

### 日志信息
系统会输出以下日志信息：
```
布隆过滤器定期保存任务已启动，间隔: 30m0s
开始定期保存布隆过滤器到文件
布隆过滤器定期保存完成
收到退出信号: interrupt，开始优雅关闭...
收到停止信号，正在保存布隆过滤器...
应用退出时布隆过滤器保存完成
优雅关闭完成
```

## 🔧 使用方法

### 1. 启动服务
```bash
go run core.go -f etc/core-api.yaml
```

### 2. 查看日志
启动后会看到类似以下日志：
```
INFO  布隆过滤器初始化完成并已保存到文件
INFO  布隆过滤器定期保存任务已启动，间隔: 30m0s
```

### 3. 优雅关闭
当使用 Ctrl+C 或 kill 命令停止服务时，系统会自动保存布隆过滤器：
```
INFO  收到退出信号: interrupt，开始优雅关闭...
INFO  收到停止信号，正在保存布隆过滤器...
INFO  应用退出时布隆过滤器保存完成
INFO  优雅关闭完成
```

## 🔄 工作流程

1. **启动时**：
   - 尝试从 `bloom_filter.data` 文件加载布隆过滤器
   - 如果文件不存在或加载失败，则创建新的布隆过滤器
   - 从数据库 `repository_pool` 表加载所有hash到布隆过滤器
   - 保存布隆过滤器到文件
   - 注册优雅关闭处理器

2. **运行时**：
   - 定期间隔到达时，自动将内存中的布隆过滤器保存到文件
   - 新增文件时，实时更新布隆过滤器
   - 监听系统退出信号

3. **重启时**：
   - 从文件快速恢复布隆过滤器状态
   - 无需重新从数据库加载所有数据

4. **退出时**：
   - 收到退出信号后，自动保存布隆过滤器到文件
   - 确保数据不丢失
   - 完成优雅关闭

## 📊 性能优化

### 优势
- ✅ **快速启动**：从文件加载比从数据库查询快得多
- ✅ **内存效率**：布隆过滤器占用内存小，查询速度快
- ✅ **自动持久化**：定期保存确保数据不丢失
- ✅ **优雅关闭**：应用退出时自动保存数据
- ✅ **可配置**：保存间隔可根据需求调整

### 注意事项
- 布隆过滤器存在一定的误判率（默认0.01）
- 文件损坏时会自动重建
- 建议定期备份 `bloom_filter.data` 文件

## 🛠️ 故障排除

### 常见问题

1. **文件权限问题**
   ```
   创建布隆过滤器文件失败: permission denied
   ```
   **解决方案**：检查程序运行目录的写权限

2. **配置解析失败**
   ```
   解析BLOOM_FILTER_SAVE_INTERVAL失败
   ```
   **解决方案**：检查环境变量格式是否正确

3. **定期保存失败**
   ```
   保存布隆过滤器到文件失败
   ```
   **解决方案**：检查磁盘空间和文件权限

## 📈 监控建议

可以通过以下方式监控布隆过滤器状态：

1. **日志监控**：关注定期保存的成功/失败日志
2. **文件监控**：监控 `bloom_filter.data` 文件的修改时间和大小
3. **性能监控**：观察文件秒传的响应时间是否正常

## 🎯 最佳实践

1. **生产环境建议**：
   - 设置较短的保存间隔（如15-30分钟）
   - 定期备份持久化文件
   - 监控文件大小增长趋势

2. **开发环境建议**：
   - 可以设置较长的保存间隔
   - 便于调试和测试

3. **高可用部署**：
   - 多实例共享同一个持久化文件
   - 或使用分布式存储方案