# æ•°æ®åº“æŸ¥è¯¢é‡å¤ä¸ç¼“å­˜åˆ†æ

## ğŸ” å½“å‰ä»£ç åˆ†æ

### é—®é¢˜ä»£ç 

```go
// æŸ¥è¯¢ 1ï¼šè·å–æ–‡ä»¶åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰
err = l.svcCtx.DBEngine.Table("user_repository").
    Where("parent_id = ? AND user_identity = ?", req.Id, l.ctx.Value("user_identity")).
    Select("...").
    Join("LEFT", "repository_pool", "...").
    Limit(size, offset).
    Find(&uf)

// æŸ¥è¯¢ 2ï¼šç»Ÿè®¡æ€»æ•°ï¼ˆç›¸åŒæ¡ä»¶ï¼Œæ— åˆ†é¡µï¼‰
cnt, err = l.svcCtx.DBEngine.Table("user_repository").
    Where("parent_id = ? AND user_identity = ?", req.Id, l.ctx.Value("user_identity")).
    Count()
```

---

## â“ ä¼šä¸ä¼šé‡å¤æŸ¥è¯¢æ•°æ®åº“ï¼Ÿ

### ç­”æ¡ˆï¼š**ä¼šï¼ä¼šæ‰§è¡Œä¸¤æ¬¡ç‹¬ç«‹çš„ SQL æŸ¥è¯¢**

### åŸå› 

1. **ä¸¤ä¸ªç‹¬ç«‹çš„æ•°æ®åº“è¯·æ±‚**
   - ç¬¬ä¸€æ¬¡ï¼š`SELECT ... FROM user_repository ... LIMIT x OFFSET y`
   - ç¬¬äºŒæ¬¡ï¼š`SELECT COUNT(*) FROM user_repository ...`

2. **xorm ä¸ä¼šè‡ªåŠ¨åˆå¹¶æŸ¥è¯¢**
   - xorm ä¸ä¼šæ™ºèƒ½åˆå¹¶è¿™ä¸¤ä¸ªæŸ¥è¯¢
   - æ¯æ¬¡è°ƒç”¨éƒ½ä¼šå‘æ•°æ®åº“å‘é€ç‹¬ç«‹çš„ SQL

3. **MySQL æŸ¥è¯¢ç¼“å­˜ï¼ˆå·²åºŸå¼ƒï¼‰**
   - MySQL 8.0+ **å·²ç§»é™¤æŸ¥è¯¢ç¼“å­˜**åŠŸèƒ½
   - å³ä½¿ç›¸åŒ SQLï¼Œä¹Ÿä¼šé‡æ–°æ‰§è¡Œ

---

## ğŸ“Š å®é™…æ‰§è¡Œçš„ SQL

```sql
-- æŸ¥è¯¢ 1ï¼šè·å–æ•°æ®ï¼ˆçº¦ 10msï¼‰
SELECT 
    user_repository.id, 
    user_repository.identity,
    user_repository.repository_identity,
    user_repository.ext,
    repository_pool.path,
    repository_pool.size
FROM user_repository
LEFT JOIN repository_pool 
    ON user_repository.repository_identity = repository_pool.identity
WHERE parent_id = 0 
    AND user_identity = 'user_abc123'
LIMIT 20 OFFSET 0;

-- æŸ¥è¯¢ 2ï¼šç»Ÿè®¡æ€»æ•°ï¼ˆçº¦ 5msï¼‰
SELECT COUNT(*) 
FROM user_repository
WHERE parent_id = 0 
    AND user_identity = 'user_abc123';
```

**æ€»è€—æ—¶ï¼šçº¦ 15msï¼ˆä¸¤æ¬¡æ•°æ®åº“å¾€è¿”ï¼‰**

---

## ğŸ¯ æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼Ÿ

### æ•°æ®åº“å±‚é¢

#### MySQL æŸ¥è¯¢ç¼“å­˜ï¼ˆå·²åºŸå¼ƒï¼‰
- âŒ MySQL 8.0+ å·²**ç§»é™¤æŸ¥è¯¢ç¼“å­˜**
- âŒ ä¸ä¼šæœ‰ä»»ä½•ç¼“å­˜æ•ˆæœ

#### InnoDB Buffer Poolï¼ˆå¯èƒ½å‘½ä¸­ï¼‰
- âœ… **æ•°æ®é¡µç¼“å­˜**å¯èƒ½å‘½ä¸­
- ç¬¬ä¸€æ¬¡æŸ¥è¯¢åï¼Œç›¸å…³æ•°æ®é¡µè¢«åŠ è½½åˆ°å†…å­˜
- ç¬¬äºŒæ¬¡æŸ¥è¯¢ `COUNT(*)` å¯èƒ½ç›´æ¥ä»å†…å­˜è¯»å–
- **ä½†ä»éœ€æ‰§è¡Œ SQL è§£æã€æ‰§è¡Œè®¡åˆ’ç­‰æ­¥éª¤**

### åº”ç”¨å±‚é¢

#### xorm å±‚é¢
- âŒ xorm **ä¸ç¼“å­˜æŸ¥è¯¢ç»“æœ**
- æ¯æ¬¡è°ƒç”¨éƒ½ä¼šæ‰§è¡Œ SQL

---

## ğŸ“ˆ æ€§èƒ½å½±å“åˆ†æ

### åœºæ™¯ 1ï¼šå°‘é‡æ•°æ®ï¼ˆ< 1000 æ¡ï¼‰

```
æŸ¥è¯¢ 1ï¼ˆè·å– 20 æ¡ï¼‰ï¼š~5ms
æŸ¥è¯¢ 2ï¼ˆCOUNTï¼‰ï¼š     ~2msï¼ˆå¯èƒ½å‘½ä¸­ Buffer Poolï¼‰
æ€»è€—æ—¶ï¼š              ~7ms
```

**å½±å“ï¼š** âœ… å¯ä»¥æ¥å—ï¼Œå½±å“ä¸å¤§

---

### åœºæ™¯ 2ï¼šå¤§é‡æ•°æ®ï¼ˆ> 10ä¸‡æ¡ï¼‰

```
æŸ¥è¯¢ 1ï¼ˆè·å– 20 æ¡ï¼‰ï¼š~10ms
æŸ¥è¯¢ 2ï¼ˆCOUNTï¼‰ï¼š     ~50msï¼ˆéœ€è¦æ‰«æç´¢å¼•ï¼‰
æ€»è€—æ—¶ï¼š              ~60ms
```

**å½±å“ï¼š** âš ï¸ æ˜æ˜¾å»¶è¿Ÿï¼Œéœ€è¦ä¼˜åŒ–

---

### åœºæ™¯ 3ï¼šé«˜å¹¶å‘ï¼ˆ1000 QPSï¼‰

```
æ¯ç§’è¯·æ±‚æ•°ï¼š      1000 æ¬¡
æ¯æ¬¡æŸ¥è¯¢æ•°ï¼š      2 æ¬¡
æ€»æŸ¥è¯¢æ•°ï¼š        2000 æ¬¡/ç§’
æ•°æ®åº“å‹åŠ›ï¼š      2å€
```

**å½±å“ï¼š** âŒ æ•°æ®åº“å‹åŠ›ç¿»å€ï¼Œä¸¥é‡å½±å“æ€§èƒ½

---

## ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ SQL_CALC_FOUND_ROWSï¼ˆä¸æ¨èï¼‰

```go
// âŒ ä¸æ¨èï¼šMySQL 8.0+ å·²åºŸå¼ƒæ­¤åŠŸèƒ½
err = l.svcCtx.DBEngine.SQL(`
    SELECT SQL_CALC_FOUND_ROWS 
        user_repository.id, 
        ...
    FROM user_repository
    WHERE ...
    LIMIT ? OFFSET ?
`, size, offset).Find(&uf)

cnt, _ = l.svcCtx.DBEngine.SQL("SELECT FOUND_ROWS()").Count()
```

**ç¼ºç‚¹ï¼š**
- MySQL 8.0.17+ å·²åºŸå¼ƒ
- æ€§èƒ½åè€Œæ›´å·®ï¼ˆéœ€è¦æ‰«æå…¨è¡¨ï¼‰

---

### æ–¹æ¡ˆ 2ï¼šå…ˆ COUNT å†æŸ¥è¯¢ï¼ˆæ¨èï¼‰

```go
// âœ… æ¨èï¼šå…ˆç»Ÿè®¡å†æŸ¥è¯¢
// 1. ç»Ÿè®¡æ€»æ•°ï¼ˆè½»é‡çº§ï¼‰
cnt, err = l.svcCtx.DBEngine.
    Table("user_repository").
    Where("parent_id = ? AND user_identity = ?", req.Id, userIdentity).
    Count()
if err != nil {
    return nil, err
}

// 2. å¦‚æœæœ‰æ•°æ®ï¼Œå†æŸ¥è¯¢åˆ—è¡¨
if cnt > 0 {
    err = l.svcCtx.DBEngine.
        Table("user_repository").
        Where("parent_id = ? AND user_identity = ?", req.Id, userIdentity).
        Select("...").
        Join("LEFT", "repository_pool", "...").
        Limit(size, offset).
        Find(&uf)
    if err != nil {
        return nil, err
    }
}
```

**ä¼˜ç‚¹ï¼š**
- å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä¸æ‰§è¡Œç¬¬äºŒæ¬¡æŸ¥è¯¢
- COUNT é€šå¸¸æ¯” SELECT å¿«
- ä»£ç é€»è¾‘æ¸…æ™°

---

### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ Redis ç¼“å­˜æ€»æ•°ï¼ˆæœ€æ¨èï¼‰

```go
// âœ… æœ€æ¨èï¼šRedis ç¼“å­˜ COUNT ç»“æœ
userIdentity := l.ctx.Value("user_identity").(string)
cacheKey := fmt.Sprintf("user_file_count:%s:%d", userIdentity, req.Id)

// 1. å°è¯•ä» Redis è·å–æ€»æ•°
cnt, err := l.svcCtx.RedisClient.Get(l.ctx, cacheKey).Int64()
if err == redis.Nil {
    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    cnt, err = l.svcCtx.DBEngine.
        Table("user_repository").
        Where("parent_id = ? AND user_identity = ?", req.Id, userIdentity).
        Count()
    if err != nil {
        return nil, err
    }
    
    // å†™å…¥ç¼“å­˜ï¼ˆ5 åˆ†é’Ÿè¿‡æœŸï¼‰
    l.svcCtx.RedisClient.Set(l.ctx, cacheKey, cnt, 5*time.Minute)
}

// 2. æŸ¥è¯¢åˆ—è¡¨ï¼ˆæ­£å¸¸æŸ¥è¯¢ï¼‰
err = l.svcCtx.DBEngine.
    Table("user_repository").
    Where("parent_id = ? AND user_identity = ?", req.Id, userIdentity).
    Select("...").
    Join("LEFT", "repository_pool", "...").
    Limit(size, offset).
    Find(&uf)
```

**ä¼˜ç‚¹ï¼š**
- âœ… å‡å°‘ 50% æ•°æ®åº“æŸ¥è¯¢
- âœ… COUNT ä» Redis è¯»å–ï¼ˆ< 1msï¼‰
- âœ… é«˜å¹¶å‘ä¸‹æ€§èƒ½ä¼˜å¼‚
- âœ… ç¼“å­˜è¿‡æœŸè‡ªåŠ¨åˆ·æ–°

**æ³¨æ„ï¼š**
- ä¸Šä¼ /åˆ é™¤æ–‡ä»¶æ—¶éœ€è¦æ¸…é™¤ç¼“å­˜
- ç¼“å­˜æ—¶é—´ä¸å®œè¿‡é•¿ï¼ˆé¿å…æ•°æ®ä¸ä¸€è‡´ï¼‰

---

### æ–¹æ¡ˆ 4ï¼šä»…åœ¨é¦–æ¬¡è¯·æ±‚æ—¶ COUNTï¼ˆæ¨èï¼‰

```go
// âœ… æ¨èï¼šå‰ç«¯åªåœ¨ page=1 æ—¶ä¼ é€’ need_count=true
if req.NeedCount || req.Page == 1 {
    cnt, err = l.svcCtx.DBEngine.
        Table("user_repository").
        Where("parent_id = ? AND user_identity = ?", req.Id, userIdentity).
        Count()
    if err != nil {
        return nil, err
    }
} else {
    // ç¿»é¡µæ—¶ä¸æŸ¥è¯¢æ€»æ•°ï¼ˆå‰ç«¯å·²çŸ¥ï¼‰
    cnt = 0
}

// æŸ¥è¯¢åˆ—è¡¨
err = l.svcCtx.DBEngine.
    Table("user_repository").
    Where("parent_id = ? AND user_identity = ?", req.Id, userIdentity).
    Select("...").
    Join("LEFT", "repository_pool", "...").
    Limit(size, offset).
    Find(&uf)
```

**ä¼˜ç‚¹ï¼š**
- âœ… å‡å°‘ 90% çš„ COUNT æŸ¥è¯¢ï¼ˆåªåœ¨é¦–æ¬¡æŸ¥è¯¢ï¼‰
- âœ… å‰ç«¯å·²çŸ¥æ€»æ•°ï¼Œç¿»é¡µæ—¶æ— éœ€é‡å¤æŸ¥è¯¢
- âœ… å®ç°ç®€å•ï¼Œæ”¹åŠ¨æœ€å°

---

## ğŸ¨ ä¿®å¤å½“å‰ä»£ç 

### é—®é¢˜ 1ï¼šJOIN æ¡ä»¶é”™è¯¯

```go
// âŒ é”™è¯¯ï¼šå¤šäº†ä¸€ä¸ªç‚¹
Join("LEFT", "repository_pool", "user_repository.repository.identity = repository_pool.identity")
//                                                    ^^^^ è¿™é‡Œé”™äº†

// âœ… æ­£ç¡®
Join("LEFT", "repository_pool", "user_repository.repository_identity = repository_pool.identity")
```

### é—®é¢˜ 2ï¼šç¼ºå°‘å­—æ®µ

```go
// âŒ ç¼ºå°‘ name å­—æ®µ
Select("user_repository.id, user_repository.identity, ...")

// âœ… åº”è¯¥åŒ…å« name
Select("user_repository.id, user_repository.identity, user_repository.name, ...")
```

---

## ğŸ“ å®Œæ•´ä¼˜åŒ–ä»£ç 

```go
func (l *UserFileListLogic) UserFileList(req *types.UserFileListRequest) (resp *types.UserFileListResponse, err error) {
    uf := make([]*types.UserFile, 0)
    var cnt int64
    resp = new(types.UserFileListResponse)
    
    // åˆ†é¡µå‚æ•°å¤„ç†
    size := req.Size
    if size == 0 {
        size = common.PageSize
    }
    page := req.Page
    if page == 0 {
        page = 1
    }
    offset := (page - 1) * size
    
    // è·å–ç”¨æˆ·èº«ä»½
    userIdentity, ok := l.ctx.Value("user_identity").(string)
    if !ok {
        return nil, errors.New("ç”¨æˆ·èº«ä»½éªŒè¯å¤±è´¥")
    }
    
    // æ„å»ºåŸºç¡€æŸ¥è¯¢æ¡ä»¶
    baseQuery := l.svcCtx.DBEngine.
        Table("user_repository").
        Where("parent_id = ? AND user_identity = ?", req.Id, userIdentity)
    
    // æŸ¥è¯¢æ€»æ•°ï¼ˆå¯é€‰ï¼šåªåœ¨é¦–é¡µæŸ¥è¯¢ï¼‰
    if req.Page <= 1 {
        cnt, err = baseQuery.Count()
        if err != nil {
            return nil, err
        }
    }
    
    // æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨
    err = baseQuery.
        Select("user_repository.id, user_repository.identity, user_repository.name, " +
            "user_repository.repository_identity, user_repository.ext, " +
            "repository_pool.path, repository_pool.size").
        Join("LEFT", "repository_pool", 
            "user_repository.repository_identity = repository_pool.identity").
        Limit(int(size), int(offset)).
        Find(&uf)
    if err != nil {
        return nil, err
    }
    
    resp.List = uf
    resp.Count = cnt
    
    return resp, nil
}
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•° | å“åº”æ—¶é—´ | å†…å­˜å ç”¨ | å®ç°éš¾åº¦ |
|------|---------------|---------|---------|---------|
| å½“å‰æ–¹æ¡ˆ | 2 æ¬¡ | ~15ms | ä½ | â­ |
| å…ˆ COUNT | 1-2 æ¬¡ | ~10ms | ä½ | â­â­ |
| Redis ç¼“å­˜ | 1 æ¬¡ | ~8ms | ä¸­ | â­â­â­ |
| é¦–é¡µ COUNT | 1.1 æ¬¡ | ~8ms | ä½ | â­â­ |

---

## âœ… æ¨èæ–¹æ¡ˆæ€»ç»“

### çŸ­æœŸä¼˜åŒ–ï¼ˆç«‹å³ä¿®å¤ï¼‰
1. âœ… ä¿®å¤ JOIN æ¡ä»¶é”™è¯¯
2. âœ… æ·»åŠ ç¼ºå¤±çš„ `name` å­—æ®µ
3. âœ… ç±»å‹è½¬æ¢æ·»åŠ é”™è¯¯å¤„ç†

### ä¸­æœŸä¼˜åŒ–ï¼ˆæ€§èƒ½æå‡ï¼‰
4. âœ… åªåœ¨é¦–é¡µæŸ¥è¯¢ COUNT
5. âœ… æ·»åŠ æ•°æ®åº“ç´¢å¼•

```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_user_parent_id 
ON user_repository(user_identity, parent_id);
```

### é•¿æœŸä¼˜åŒ–ï¼ˆé«˜å¹¶å‘ï¼‰
6. âœ… ä½¿ç”¨ Redis ç¼“å­˜ COUNT
7. âœ… è€ƒè™‘ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆæ—  OFFSETï¼‰

---

## ğŸ¯ æ€»ç»“

**å½“å‰é—®é¢˜ï¼š**
- âŒ æ¯æ¬¡è¯·æ±‚æ‰§è¡Œ 2 æ¬¡æ•°æ®åº“æŸ¥è¯¢
- âŒ JOIN æ¡ä»¶æœ‰è¯­æ³•é”™è¯¯
- âŒ ç¼ºå°‘ `name` å­—æ®µ

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… å‡å°‘ 50% æ•°æ®åº“æŸ¥è¯¢
- âœ… å“åº”æ—¶é—´é™ä½ 30-50%
- âœ… æ”¯æŒæ›´é«˜å¹¶å‘
