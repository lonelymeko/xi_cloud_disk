# 玺云盘系统架构说明

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                           客户端                                  │
│                    (Web / iOS / Android)                         │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ HTTP/HTTPS
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│                      Go-Zero API Server                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    HTTP Handler Layer                        ││
│  │  - 用户认证（JWT Middleware）                                ││
│  │  - 请求解析和验证                                             ││
│  │  - 响应封装                                                  ││
│  └───────────────────────────┬─────────────────────────────────┘│
│                              │                                   │
│  ┌───────────────────────────┴─────────────────────────────────┐│
│  │                    Logic Layer                               ││
│  │  - 用户逻辑（注册、登录、信息查询）                           ││
│  │  - 文件逻辑（上传、下载、管理）                              ││
│  │  - 分享逻辑（创建、查询、保存）                              ││
│  └───────────────────────────┬─────────────────────────────────┘│
│                              │                                   │
│  ┌───────────────────────────┴─────────────────────────────────┐│
│  │                    Service Layer                             ││
│  │  - DBEngine (MySQL)                                          ││
│  │  - RedisClient                                               ││
│  │  - RabbitMQConn                                              ││
│  └──────────────────────────────────────────────────────────────┘│
└────────┬────────────────┬─────────────────┬─────────────────────┘
         │                │                 │
         ↓                ↓                 ↓
┌─────────────┐  ┌─────────────┐  ┌──────────────────┐
│    MySQL    │  │    Redis    │  │    RabbitMQ      │
│  数据持久化  │  │  缓存/验证码 │  │   消息队列        │
└─────────────┘  └─────────────┘  └────────┬─────────┘
                                           │
                                           │ 消费消息
                                           ↓
                                  ┌─────────────────┐
                                  │  Worker进程      │
                                  │  - 文件压缩      │
                                  │  - OSS上传       │
                                  │  - 数据库更新    │
                                  └────────┬────────┘
                                           │
                                           ↓
                                  ┌─────────────────┐
                                  │  Aliyun OSS     │
                                  │  对象存储        │
                                  └─────────────────┘
```

## 异步文件上传流程

```
┌──────────┐
│  客户端   │
└────┬─────┘
     │
     │ 1. POST /api/file/upload
     │    (multipart/form-data)
     ↓
┌─────────────────────────────────┐
│  upload_file_handler.go         │
│  1. 接收文件保存到临时目录        │
│  2. 计算 MD5 hash                │
│  3. 检查秒传（查询 repository_pool）│
│  └─ 文件存在 → 秒传               │
│  └─ 文件不存在 → 继续处理          │
└────┬────────────────────────────┘
     │
     │ 2. 创建上传事件
     │    (UploadEvent JSON)
     ↓
┌─────────────────────────────────┐
│  upload_file_logic.go           │
│  1. 封装上传事件                  │
│  2. 发布到 RabbitMQ               │
│  3. 返回 "文件上传开始"            │
└────┬────────────────────────────┘
     │
     │ < 1秒响应
     ↓
┌──────────┐
│  客户端   │  收到响应
└──────────┘

     ↓ (异步处理)
┌─────────────────────────────────┐
│  RabbitMQ                        │
│  Exchange: upload.event.exchange│
│  Queue: upload.process.queue    │
│  Routing: upload.new             │
└────┬────────────────────────────┘
     │
     │ 3. Worker 消费消息
     ↓
┌─────────────────────────────────┐
│  consumer.go (Worker)            │
│  1. 解析上传事件                  │
│  2. 打开临时文件                  │
│  3. 判断文件类型                  │
│     ├─ 视频 → ffmpeg 压缩         │
│     ├─ 图片 → 图片压缩            │
│     └─ 其他 → 不压缩              │
│  4. 判断文件大小                  │
│     ├─ >100MB → 分片上传          │
│     └─ <100MB → 普通上传          │
│  5. 上传到 OSS                    │
│  6. 插入 repository_pool         │
│  7. 插入 user_repository         │
│  8. 删除临时文件                  │
│  9. Ack 确认消息                  │
└─────────────────────────────────┘
```

## 分片上传流程

```
┌─────────────┐
│ 大文件 >100MB │
└──────┬──────┘
       │
       │ 1. 判断文件大小
       ↓
┌─────────────────────────────────┐
│  UploadToOSSMultipart()         │
│  1. 初始化分片上传                 │
│     InitiateMultipartUpload()   │
│  2. 计算分片数量                  │
│     partCount = fileSize / 10MB │
└────┬────────────────────────────┘
     │
     │ 2. 并发上传分片
     ↓
┌─────────────────────────────────┐
│  Goroutine Pool (3 并发)         │
│  ┌─────────────────────────────┐│
│  │  Part 1 (10MB)               ││
│  │  ┌──────────────────────┐   ││
│  │  │ 重试 1/3               │   ││
│  │  │ UploadPart() → OSS    │   ││
│  │  │ 返回 ETag             │   ││
│  │  └──────────────────────┘   ││
│  └─────────────────────────────┘│
│  ┌─────────────────────────────┐│
│  │  Part 2 (10MB)               ││
│  │  同上...                     ││
│  └─────────────────────────────┘│
│  ┌─────────────────────────────┐│
│  │  Part 3 (10MB)               ││
│  │  同上...                     ││
│  └─────────────────────────────┘│
└────┬────────────────────────────┘
     │
     │ 3. 等待所有分片完成
     ↓
┌─────────────────────────────────┐
│  CompleteMultipartUpload()      │
│  1. 收集所有 ETag                 │
│  2. 完成分片上传                  │
│  3. OSS 合并分片                  │
│  4. 返回最终文件 URL              │
└─────────────────────────────────┘
```

## 数据库表结构

### repository_pool（全局文件池）
```sql
CREATE TABLE repository_pool (
    id INT PRIMARY KEY AUTO_INCREMENT,
    identity VARCHAR(36) UNIQUE NOT NULL,  -- UUID
    hash VARCHAR(32) UNIQUE NOT NULL,      -- MD5 (唯一索引，秒传关键)
    name VARCHAR(255) NOT NULL,            -- 文件名
    ext VARCHAR(50) NOT NULL,              -- 扩展名
    size BIGINT NOT NULL,                  -- 文件大小（压缩后）
    path VARCHAR(500) NOT NULL,            -- OSS 路径
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    INDEX idx_hash (hash),
    INDEX idx_identity (identity)
);
```

### user_repository（用户文件关联表）
```sql
CREATE TABLE user_repository (
    id INT PRIMARY KEY AUTO_INCREMENT,
    identity VARCHAR(36) UNIQUE NOT NULL,         -- UUID
    user_identity VARCHAR(36) NOT NULL,           -- 用户 ID
    repository_identity VARCHAR(36) NOT NULL,     -- 关联 repository_pool
    parent_id BIGINT DEFAULT 0,                   -- 父文件夹 ID
    name VARCHAR(255) NOT NULL,                   -- 文件/文件夹名
    ext VARCHAR(50) DEFAULT '',                   -- 扩展名
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    INDEX idx_user (user_identity),
    INDEX idx_parent (parent_id),
    INDEX idx_repo (repository_identity),
    FOREIGN KEY (repository_identity) REFERENCES repository_pool(identity)
);
```

## RabbitMQ 配置

### 交换机（Exchange）
- **名称：** `upload.event.exchange`
- **类型：** Direct
- **持久化：** 是
- **自动删除：** 否

### 队列（Queue）
- **名称：** `upload.process.queue`
- **持久化：** 是
- **自动删除：** 否
- **独占：** 否
- **绑定路由键：** `upload.new`

### 消息（Message）
- **内容类型：** application/json
- **持久化：** Persistent (DeliveryMode=2)
- **结构：**
  ```json
  {
    "user_identity": "uuid",
    "parent_id": 0,
    "file_path": "/tmp/upload-xxx",
    "ext": ".mp4",
    "name": "video.mp4",
    "size": 518428843,
    "is_existed": false,
    "repository_identity": "uuid",
    "hash": "md5hash"
  }
  ```

### Worker 配置
- **QoS Prefetch：** 1（单个 Worker 最多处理 1 个任务）
- **手动 Ack：** 是
- **重试次数：** 3
- **失败处理：** Nack（不重新入队）

## 性能优化点

### 1. 异步处理
- **问题：** 同步上传导致 API 响应慢（2-3 分钟）
- **方案：** RabbitMQ 异步处理 + 后台 Worker
- **效果：** API 响应时间 < 1 秒

### 2. 分片上传
- **问题：** 大文件上传慢且容易失败
- **方案：** 10MB 分片 + 3 并发 + 重试机制
- **效果：** 500MB 文件上传速度 3-4 MB/s

### 3. 文件秒传
- **问题：** 重复文件浪费存储和上传时间
- **方案：** MD5 hash 唯一索引 + repository_pool 去重
- **效果：** 相同文件立即返回，无需上传

### 4. CTE 递归删除
- **问题：** 循环递归导致 N+1 查询
- **方案：** MySQL 8.0 CTE 递归查询
- **效果：** 性能提升 95%

### 5. 智能压缩
- **问题：** 原始文件占用大量存储空间
- **方案：** 视频自动压缩（ffmpeg）+ 图片压缩
- **效果：** 平均压缩率 60%

## 扩展性设计

### 横向扩展
- **API Server：** 可部署多个实例，通过负载均衡分发
- **Worker：** 可启动多个 Worker 进程消费队列
- **RabbitMQ：** 支持集群部署
- **Redis：** 支持主从复制和 Sentinel
- **MySQL：** 支持主从复制和读写分离

### 监控告警
- **RabbitMQ：** 通过管理界面监控队列堆积
- **Worker：** 日志记录处理耗时和成功率
- **API：** Go-Zero 内置 Prometheus 指标
- **OSS：** 阿里云控制台监控流量和存储

## 部署建议

### 开发环境
```bash
# 单机部署
- MySQL: 本地安装
- Redis: 本地安装
- RabbitMQ: Docker 快速启动
- API Server: go run
- Worker: 同进程启动
```

### 生产环境
```bash
# 分布式部署
- MySQL: 阿里云 RDS
- Redis: 阿里云 Redis
- RabbitMQ: 阿里云消息队列 RabbitMQ 版
- API Server: 2+ 实例 + 负载均衡
- Worker: 3+ 独立进程
- OSS: 阿里云 OSS
```

## 安全考虑

1. **文件上传限制**
   - 最大文件大小：10GB
   - 支持的文件类型：白名单控制
   - 病毒扫描：集成 ClamAV

2. **认证授权**
   - JWT Token 认证
   - Token 过期时间：10 小时
   - 刷新 Token 机制

3. **数据加密**
   - 密码：MD5 + 盐值
   - OSS：HTTPS 传输
   - 敏感数据：加密存储

4. **防攻击**
   - 速率限制：Redis + Go-Zero 限流
   - SQL 注入：ORM 框架防护
   - XSS：前端输入验证

## 故障处理

### 常见问题

1. **RabbitMQ 连接失败**
   - 检查服务是否启动
   - 检查防火墙配置
   - 检查账号密码

2. **文件上传失败**
   - 检查 OSS 配置
   - 检查网络连接
   - 查看 Worker 日志

3. **数据库连接超时**
   - 检查连接池配置
   - 检查慢查询日志
   - 优化索引

4. **消息堆积**
   - 增加 Worker 数量
   - 检查 Worker 处理性能
   - 调整 QoS 配置

---

**文档版本：** v2.0.0  
**更新日期：** 2026-02-06  
**维护者：** xixiu
